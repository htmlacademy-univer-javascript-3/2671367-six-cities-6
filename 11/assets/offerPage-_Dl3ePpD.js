import{j as e,r as n,b as w,h as d,k as g,R,m as c,n as S,A as C,u as O,o as A,p as T,q as k,s as B}from"./index-BzgjDag3.js";import{a as E,b as L,C as D}from"./cityMap-B91Yk_UU.js";import{H as F,d as I,O as P}from"./headerContainer-CCqZMth_.js";const U=s=>r=>s?r.review.reviewsByOfferId[s]??[]:[],H=s=>s.review.isLoading,$=s=>s.review.error,z=({review:s})=>e.jsxs("li",{className:"reviews__item",children:[e.jsxs("div",{className:"reviews__user user",children:[e.jsx("div",{className:"reviews__avatar-wrapper user__avatar-wrapper",children:e.jsx("img",{className:"reviews__avatar user__avatar",src:s.user.avatarUrl,width:"54",height:"54",alt:"Reviews avatar"})}),e.jsx("span",{className:"reviews__user-name",children:s.user.name})]}),e.jsxs("div",{className:"reviews__info",children:[e.jsx("div",{className:"reviews__rating rating",children:e.jsxs("div",{className:"reviews__stars rating__stars",children:[e.jsx("span",{style:{width:`${s.rating*20}%`}}),e.jsx("span",{className:"visually-hidden",children:"Rating"})]})}),e.jsx("p",{className:"reviews__text",children:s.comment}),e.jsx("time",{className:"reviews__time",dateTime:s.date,children:(()=>{try{return new Date(s.date).toLocaleString("en-US",{month:"long",day:"numeric",year:"numeric"})}catch{return"Invalid date"}})()})," "]})]}),G=[5,4,3,2,1],V=s=>{switch(s){case 5:return c.Perfect;case 4:return c.Good;case 3:return c.NotBad;case 2:return c.Badly;default:return c.Terribly}},q=({offerId:s})=>{const[r,i]=n.useState(null),[a,l]=n.useState(""),u=w(),h=d(H),_=d($),p=n.useCallback(t=>i(Number(t.target.value)),[]),j=n.useCallback(t=>l(t.target.value),[]),[f,o]=n.useState(!1),[v,x]=n.useState(null),N=n.useCallback(t=>{if(t.preventDefault(),x(null),r===null||a.length<50){x("Please set a rating and write at least 50 characters.");return}o(!0);const b=setTimeout(()=>o(!1),1e4);u(g({offerId:s,rating:r,comment:a})).then(y=>{clearTimeout(b),o(!1),g.fulfilled.match(y)&&(i(null),l(""))})},[u,s,r,a]),m=h||f;return e.jsxs("form",{className:"reviews__form form",onSubmit:N,children:[e.jsx("label",{className:"reviews__label form__label",htmlFor:"review",children:"Your review"}),_&&e.jsx("div",{className:"reviews__error",style:{color:"red",marginBottom:"10px"},children:_.message||"Failed to submit review. Please try again."}),v&&e.jsx("div",{className:"reviews__error",style:{color:"red",marginBottom:"10px"},children:v}),e.jsx("div",{className:"reviews__rating-form form__rating",children:G.map(t=>e.jsxs(R.Fragment,{children:[e.jsx("input",{className:"form__rating-input visually-hidden",name:"rating",value:t,id:`rating-${t}`,type:"radio",checked:r===t,onChange:p,disabled:m}),e.jsx("label",{htmlFor:`rating-${t}`,className:"reviews__rating-label form__rating-label",title:V(t),children:e.jsx("svg",{className:"form__star-image",width:"37",height:"33",children:e.jsx("use",{xlinkHref:"#icon-star"})})})]},t))}),e.jsx("textarea",{className:"reviews__textarea form__textarea",id:"review",name:"review",placeholder:"Tell how was your stay, what you like and what can be improved",value:a,onChange:j,disabled:m}),e.jsxs("div",{className:"reviews__button-wrapper",children:[e.jsxs("p",{className:"reviews__help",children:["To submit review please make sure to set"," ",e.jsx("span",{className:"reviews__star",children:"rating"})," and describe your stay with at least ",e.jsx("b",{className:"reviews__text-amount",children:"50 characters"}),"."]}),e.jsx("button",{className:"reviews__submit form__submit button",type:"submit",disabled:m,children:h||f?"Submitting...":"Submit"})]})]})},M=({reviews:s,offerId:r})=>{const a=d(S)===C.Auth;return e.jsxs("section",{className:"offer__reviews reviews",children:[e.jsxs("h2",{className:"reviews__title",children:["Reviews Â· ",e.jsx("span",{className:"reviews__amount",children:s.length})]}),e.jsx("ul",{className:"reviews__list",children:s.map(l=>e.jsx(z,{review:l},l.id))}),a&&e.jsx(q,{offerId:r})]})},Y=s=>O(U(s)),W=()=>{const s=E(),r=L(),{id:i}=A(),a=w(),l=Y(i);return n.useEffect(()=>{i&&(a(T(i)),a(k(i)))},[i,a]),n.useEffect(()=>{s&&a(B({id:s.id,city:s.city.name}))},[a,s]),s?e.jsxs("div",{className:"page",children:[e.jsx(F,{}),e.jsxs("main",{className:"page__main page__main--offer",children:[e.jsx(I,{offer:s,reviews:e.jsx(M,{reviews:l,offerId:s.id})}),e.jsx("section",{className:"offer__map map",children:e.jsx(D,{city:s.city,offers:[s,...r.slice(0,5)]})}),e.jsx("div",{className:"container",children:e.jsxs("section",{className:"near-places places",children:[e.jsx("h2",{className:"near-places__title",children:"Other places in the neighbourhood"}),e.jsx(P,{offers:r.slice(0,5),variant:"near-places"})]})})]})]}):null};export{W as default};
